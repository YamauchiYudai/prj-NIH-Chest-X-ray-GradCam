# Instruction: NIH-Chest-X-ray Pipeline Verification (Smoke Test)

## コンテキスト
前回のプロトタイプ実装（Docker + Hydra + PyTorch）に基づき、実際のデータセットを用いてパイプラインの動作検証（スモークテスト）を行いたいです。

## ⚠️ 重要: トークン節約のための制約事項
* **画像ディレクトリの閲覧禁止**: `data/images_00{i}/` 以下のディレクトリを、ファイル操作ツール（`list_dir`等）で閲覧・確認しないでください。画像が大量にあり、コンテキスト（トークン）を圧迫するためです。
* **情報の利用**: ディレクトリ構造については、本ドキュメントの「データセット構造の仕様」に記載された情報のみを正としてコードを記述してください。

## 目標
1. 複雑なディレクトリ構造から、コード実行時に動的に画像パスを解決するロジックを実装する。
2. 1〜2枚のサンプル画像のみを使用して、データ読み込み → モデル推論 → Grad-CAM生成 までの一連の処理がエラーなく動作することを確認する。

## データセット構造の仕様 (所与の情報として扱うこと)
* **ルート**: `./data`
* **画像格納ルール**: 画像は複数のサブフォルダに分散しています。
    * パターン: `data/images_{001〜012}/images/{filename}.png`
    * 例: `00000001_000.png` は `data/images_001/images/` にあるかもしれないし、 `data/images_002/images/` にあるかもしれません。
* **リストファイル**:
    * `train_val_list.txt`: 学習/検証用ファイル名リスト（ファイル名のみ記載）
    * `test_list.txt`: テスト用ファイル名リスト
* **ラベル情報**: 検証用のため、CSVファイル（`Data_Entry_2017.csv`）の読み込みは必須としません。存在しない場合はダミーラベルを使用してください。

## 実装タスク

### Task 1: パス解決ロジックの実装 (`src/utils/file_finder.py`)
Cline自身がファイルを探すのではなく、**Pythonスクリプトが** 実行時に画像パスを見つけるためのヘルパー関数を作成してください。

* **要件**:
    * 関数 `find_image_path(filename, data_root="./data") -> str`
    * 実装方針: `glob` を使って `data/**/{filename}` を探すか、`images_001` から `images_012` までのフォルダパスを生成して `os.path.exists` で順次チェックするロジックなどが考えられます。
    * **推奨**: 今回は数枚のテストなので、`glob` で全ファイルをスキャンして辞書を作るよりも、対象のファイルが見つかるまでサブディレクトリ（`images_001`...）をループでチェックする方式が（初期化コスト的に）軽量です。

### Task 2: データセットクラスの更新 (`src/data/dataset.py`)
* `__init__` メソッド内で Task 1 のロジックを使用し、ファイル名からフルパスを取得するように修正してください。
* **Debug Mode**: 引数 `debug=True` を追加してください。
    * `debug=True` の場合: リストファイル（`train_val_list.txt`）の**先頭2行のみ**を読み込み対象としてください。
    * **ラベル処理**: ラベルCSVが見つからない、または読み込めない場合は、ランダムなクラス、あるいは「No Finding」相当のダミーラベル（ゼロベクトル等）を自動生成してエラーを防いでください。

### Task 3: 検証用実行スクリプト (`verify_pipeline.py`)
`main.py` とは別に、以下の処理を行う軽量な検証スクリプトを作成してください。Hydraの設定ファイルの一部をオーバーライドして使用しても構いません。

1. **Setup**: ResNet50 (or Configで指定されたモデル) をロード。
2. **Data**: `debug=True` でデータセットとDataLoaderを作成（バッチサイズ=2）。
3. **Inference**: 1バッチ分だけ推論を実行し、エラーが出ないか確認。
4. **Grad-CAM**: 推論した画像に対してGrad-CAMを実行。
5. **Output**: 結果画像を `verification_result.png` として保存。ヒートマップが元のX線画像に重畳されていることを確認できるようにすること。

## 期待される成果物
* `src/utils/file_finder.py`
* 修正された `src/data/dataset.py`
* `verify_pipeline.py`
* 実行成功ログ（"Verification Completed: Saved to verification_result.png" 等）